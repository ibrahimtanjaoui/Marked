<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Review Justification | Marked</title>
        <link rel="icon" type="image/svg+xml" th:href="@{/img/favicon.svg}" />
        <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
        <link rel="stylesheet" th:href="@{/css/style.css}" />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
        />
    </head>
    <body class="page-wrapper">
        <nav class="navbar-area sticky">
            <div class="container">
                <div class="navbar">
                    <a
                        th:href="@{/professors/{id}(id=${professor.id})}"
                        class="navbar-brand"
                    >
                        <span class="brand-icon">M</span>
                        Marked
                    </a>

                    <button
                        class="navbar-toggler"
                        type="button"
                        onclick="toggleMenu()"
                    >
                        <span class="toggler-icon"></span>
                        <span class="toggler-icon"></span>
                        <span class="toggler-icon"></span>
                    </button>

                    <div class="navbar-collapse" id="navbarCollapse">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a
                                    th:href="@{/professors/{id}(id=${professor.id})}"
                                    >Dashboard</a
                                >
                            </li>
                            <li class="nav-item">
                                <a
                                    th:href="@{/professors/{id}/sessions(id=${professor.id})}"
                                    >Sessions</a
                                >
                            </li>
                            <li class="nav-item">
                                <a
                                    th:href="@{/professors/{id}/justifications(id=${professor.id})}"
                                    class="active"
                                    >Justifications</a
                                >
                            </li>
                            <li class="nav-item">
                                <form
                                    th:action="@{/auth/logout}"
                                    method="post"
                                    style="display: inline"
                                >
                                    <button type="submit" class="btn-logout">
                                        <i class="bi bi-box-arrow-right"></i>
                                        Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Dashboard Header -->
        <header class="dashboard-header">
            <div class="container">
                <h1>Review Justification</h1>
                <p>
                    <span
                        th:if="${attendance.student != null}"
                        th:text="${attendance.student.firstName + ' ' + attendance.student.familyName}"
                        >Student Name</span
                    >
                    <span class="text-muted"> Â· </span>
                    <span
                        th:if="${attendance.session != null && attendance.session.timeTable != null && attendance.session.timeTable.courseAssignment != null && attendance.session.timeTable.courseAssignment.course != null}"
                        th:text="${attendance.session.timeTable.courseAssignment.course.name}"
                        >Course</span
                    >
                </p>
            </div>
        </header>

        <main class="dashboard-content">
            <div class="container" style="max-width: 900px">
                <!-- Flash Messages -->
                <div
                    th:if="${success}"
                    class="alert alert-success"
                    style="margin-bottom: 1.5rem"
                    id="successAlert"
                    th:text="${success}"
                ></div>
                <div
                    th:if="${error}"
                    class="alert alert-danger"
                    style="margin-bottom: 1.5rem"
                    id="errorAlert"
                    th:text="${error}"
                ></div>

                <!-- Main Content Grid -->
                <div
                    style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 1.5rem;
                    "
                >
                    <!-- Left Column -->
                    <div>
                        <!-- Student & Session Info -->
                        <div class="card" style="margin-bottom: 1.5rem">
                            <div
                                class="card-header"
                                style="
                                    padding: 1rem 1.5rem;
                                    border-bottom: 1px solid var(--gray-200);
                                "
                            >
                                <h2
                                    class="card-title"
                                    style="margin: 0; font-size: 1rem"
                                >
                                    Details
                                </h2>
                            </div>
                            <div class="card-body" style="padding: 1.5rem">
                                <table
                                    style="width: 100%; font-size: 0.9375rem"
                                >
                                    <tr>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                color: var(--gray-500);
                                                width: 120px;
                                            "
                                        >
                                            Student
                                        </td>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                font-weight: 500;
                                            "
                                        >
                                            <span
                                                th:if="${attendance.student != null}"
                                                th:text="${attendance.student.firstName + ' ' + attendance.student.familyName}"
                                                >Name</span
                                            >
                                            <span
                                                th:unless="${attendance.student != null}"
                                                class="text-muted"
                                                >-</span
                                            >
                                        </td>
                                    </tr>
                                    <tr>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                color: var(--gray-500);
                                            "
                                        >
                                            ID
                                        </td>
                                        <td style="padding: 0.5rem 0">
                                            <code
                                                th:if="${attendance.student != null}"
                                                th:text="${attendance.student.studentId}"
                                                style="
                                                    background: var(--gray-100);
                                                    padding: 0.125rem 0.375rem;
                                                    border-radius: 4px;
                                                "
                                                >STU001</code
                                            >
                                        </td>
                                    </tr>
                                    <tr>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                color: var(--gray-500);
                                            "
                                        >
                                            Course
                                        </td>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                font-weight: 500;
                                            "
                                        >
                                            <span
                                                th:if="${attendance.session != null && attendance.session.timeTable != null && attendance.session.timeTable.courseAssignment != null && attendance.session.timeTable.courseAssignment.course != null}"
                                                th:text="${attendance.session.timeTable.courseAssignment.course.name}"
                                                >Course</span
                                            >
                                            <span
                                                th:unless="${attendance.session != null && attendance.session.timeTable != null && attendance.session.timeTable.courseAssignment != null && attendance.session.timeTable.courseAssignment.course != null}"
                                                class="text-muted"
                                                >-</span
                                            >
                                        </td>
                                    </tr>
                                    <tr>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                color: var(--gray-500);
                                            "
                                        >
                                            Date
                                        </td>
                                        <td style="padding: 0.5rem 0">
                                            <span
                                                th:if="${attendance.session != null && attendance.session.calendar != null}"
                                                th:text="${#temporals.format(attendance.session.calendar.date, 'EEE, MMM d, yyyy')}"
                                                >Mon, Jan 1, 2025</span
                                            >
                                            <span
                                                th:unless="${attendance.session != null && attendance.session.calendar != null}"
                                                class="text-muted"
                                                >-</span
                                            >
                                        </td>
                                    </tr>
                                    <tr>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                color: var(--gray-500);
                                            "
                                        >
                                            Time
                                        </td>
                                        <td style="padding: 0.5rem 0">
                                            <span
                                                th:if="${attendance.session != null && attendance.session.startTime != null}"
                                                th:text="${#temporals.format(attendance.session.startTime, 'HH:mm')}"
                                                >09:00</span
                                            >
                                            <span
                                                th:if="${attendance.session != null && attendance.session.startTime != null && attendance.session.endTime != null}"
                                            >
                                                -
                                            </span>
                                            <span
                                                th:if="${attendance.session != null && attendance.session.endTime != null}"
                                                th:text="${#temporals.format(attendance.session.endTime, 'HH:mm')}"
                                                >11:00</span
                                            >
                                        </td>
                                    </tr>
                                    <tr>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                color: var(--gray-500);
                                            "
                                        >
                                            Status
                                        </td>
                                        <td style="padding: 0.5rem 0">
                                            <span
                                                th:if="${attendance.status != null && attendance.status.name() == 'ABSENT'}"
                                                class="badge badge-danger"
                                                >Absent</span
                                            >
                                            <span
                                                th:if="${attendance.status != null && attendance.status.name() == 'PRESENT'}"
                                                class="badge badge-success"
                                                >Present</span
                                            >
                                            <span
                                                th:if="${attendance.status != null && attendance.status.name() == 'LATE'}"
                                                class="badge badge-warning"
                                                >Late</span
                                            >
                                            <span
                                                th:if="${attendance.status != null && attendance.status.name() == 'EXCUSED'}"
                                                class="badge badge-info"
                                                >Excused</span
                                            >
                                            <span
                                                th:if="${attendance.status == null || attendance.status.name() == 'NOT_MARKED'}"
                                                class="badge badge-secondary"
                                                >Not Marked</span
                                            >
                                        </td>
                                    </tr>
                                    <tr>
                                        <td
                                            style="
                                                padding: 0.5rem 0;
                                                color: var(--gray-500);
                                            "
                                        >
                                            Submitted
                                        </td>
                                        <td style="padding: 0.5rem 0">
                                            <span
                                                th:if="${attendance.justificationSubmittedAt != null}"
                                                th:text="${#temporals.format(attendance.justificationSubmittedAt, 'MMM d, yyyy HH:mm')}"
                                                >Jan 1, 2025 10:00</span
                                            >
                                            <span
                                                th:unless="${attendance.justificationSubmittedAt != null}"
                                                class="text-muted"
                                                >-</span
                                            >
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div>
                        <!-- Justification Text -->
                        <div class="card" style="margin-bottom: 1.5rem">
                            <div
                                class="card-header"
                                style="
                                    padding: 1rem 1.5rem;
                                    border-bottom: 1px solid var(--gray-200);
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                "
                            >
                                <h2
                                    class="card-title"
                                    style="margin: 0; font-size: 1rem"
                                >
                                    Justification
                                </h2>
                                <span
                                    th:if="${attendance.justificationStatus != null && attendance.justificationStatus.name() == 'PENDING'}"
                                    class="badge badge-warning"
                                    >Pending</span
                                >
                                <span
                                    th:if="${attendance.justificationStatus != null && attendance.justificationStatus.name() == 'APPROVED'}"
                                    class="badge badge-success"
                                    >Approved</span
                                >
                                <span
                                    th:if="${attendance.justificationStatus != null && attendance.justificationStatus.name() == 'REJECTED'}"
                                    class="badge badge-danger"
                                    >Rejected</span
                                >
                            </div>
                            <div class="card-body" style="padding: 1.5rem">
                                <div
                                    style="
                                        background: var(--gray-50);
                                        padding: 1.25rem;
                                        border-radius: 8px;
                                        border-left: 3px solid var(--gray-300);
                                        font-size: 0.9375rem;
                                        line-height: 1.6;
                                    "
                                >
                                    <p
                                        th:if="${attendance.justificationText != null && !attendance.justificationText.isEmpty()}"
                                        th:text="${attendance.justificationText}"
                                        style="margin: 0; white-space: pre-wrap"
                                    >
                                        Justification text...
                                    </p>
                                    <p
                                        th:unless="${attendance.justificationText != null && !attendance.justificationText.isEmpty()}"
                                        class="text-muted"
                                        style="margin: 0; font-style: italic"
                                    >
                                        No justification text provided.
                                    </p>
                                </div>

                                <!-- Rejection reason if exists -->
                                <div
                                    th:if="${attendance.justificationStatus != null && attendance.justificationStatus.name() == 'REJECTED' && attendance.comment != null}"
                                    style="
                                        margin-top: 1rem;
                                        padding: 1rem;
                                        background: #fef2f2;
                                        border-radius: 8px;
                                        border-left: 3px solid var(--danger);
                                    "
                                >
                                    <strong
                                        style="
                                            color: var(--danger);
                                            font-size: 0.875rem;
                                        "
                                        >Rejection Reason:</strong
                                    >
                                    <p
                                        th:text="${attendance.comment}"
                                        style="
                                            margin: 0.5rem 0 0 0;
                                            font-size: 0.9375rem;
                                        "
                                    ></p>
                                </div>
                            </div>
                        </div>

                        <!-- Decision Actions (only for pending) -->
                        <div
                            th:if="${attendance.justificationStatus != null && attendance.justificationStatus.name() == 'PENDING'}"
                            class="card"
                        >
                            <div
                                class="card-header"
                                style="
                                    padding: 1rem 1.5rem;
                                    border-bottom: 1px solid var(--gray-200);
                                "
                            >
                                <h2
                                    class="card-title"
                                    style="margin: 0; font-size: 1rem"
                                >
                                    Decision
                                </h2>
                            </div>
                            <div class="card-body" style="padding: 1.5rem">
                                <!-- Rejection reason input -->
                                <form
                                    id="rejectForm"
                                    th:action="@{/professors/{professorId}/justifications/{attendanceId}/reject(professorId=${professor.id}, attendanceId=${attendance.id})}"
                                    method="post"
                                    style="display: none"
                                >
                                    <div
                                        class="form-group"
                                        style="margin-bottom: 1rem"
                                    >
                                        <label
                                            class="form-label"
                                            for="reason"
                                            style="font-size: 0.875rem"
                                            >Reason for rejection
                                            (optional)</label
                                        >
                                        <textarea
                                            id="reason"
                                            name="reason"
                                            class="form-control"
                                            rows="2"
                                            placeholder="Provide feedback to the student..."
                                            style="font-size: 0.9375rem"
                                        ></textarea>
                                    </div>
                                    <div style="display: flex; gap: 0.75rem">
                                        <button
                                            type="button"
                                            class="btn btn-outline"
                                            style="flex: 1"
                                            onclick="hideRejectForm()"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="submit"
                                            class="btn btn-danger"
                                            style="flex: 1"
                                        >
                                            <i class="bi bi-x-circle"></i>
                                            Confirm Reject
                                        </button>
                                    </div>
                                </form>

                                <!-- Action buttons -->
                                <div
                                    id="actionButtons"
                                    style="display: flex; gap: 0.75rem"
                                >
                                    <form
                                        th:action="@{/professors/{professorId}/justifications/{attendanceId}/approve(professorId=${professor.id}, attendanceId=${attendance.id})}"
                                        method="post"
                                        style="flex: 1"
                                    >
                                        <button
                                            type="submit"
                                            class="btn btn-success"
                                            style="width: 100%"
                                        >
                                            <i class="bi bi-check-circle"></i>
                                            Approve
                                        </button>
                                    </form>
                                    <button
                                        type="button"
                                        class="btn btn-danger"
                                        style="flex: 1"
                                        onclick="showRejectForm()"
                                    >
                                        <i class="bi bi-x-circle"></i>
                                        Reject
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Already reviewed message -->
                        <div
                            th:if="${attendance.justificationStatus != null && attendance.justificationStatus.name() != 'PENDING'}"
                            class="card"
                        >
                            <div
                                class="card-body"
                                style="padding: 1.5rem; text-align: center"
                            >
                                <p class="text-muted" style="margin: 0">
                                    <i
                                        class="bi bi-check-circle"
                                        th:if="${attendance.justificationStatus.name() == 'APPROVED'}"
                                        style="color: var(--success)"
                                    ></i>
                                    <i
                                        class="bi bi-x-circle"
                                        th:if="${attendance.justificationStatus.name() == 'REJECTED'}"
                                        style="color: var(--danger)"
                                    ></i>
                                    This justification has already been
                                    reviewed.
                                </p>
                                <p
                                    class="text-muted"
                                    style="
                                        margin: 0.5rem 0 0 0;
                                        font-size: 0.875rem;
                                    "
                                    th:if="${attendance.justificationReviewedAt != null}"
                                >
                                    Reviewed on
                                    <span
                                        th:text="${#temporals.format(attendance.justificationReviewedAt, 'MMM d, yyyy HH:mm')}"
                                        >Jan 1, 2025</span
                                    >
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="container">
                <p>&copy; 2025 Marked. All rights reserved.</p>
            </div>
        </footer>

        <script>
            function toggleMenu() {
                const navbar = document.getElementById("navbarCollapse");
                navbar.classList.toggle("show");
            }

            function showRejectForm() {
                document.getElementById("actionButtons").style.display = "none";
                document.getElementById("rejectForm").style.display = "block";
            }

            function hideRejectForm() {
                document.getElementById("rejectForm").style.display = "none";
                document.getElementById("actionButtons").style.display = "flex";
            }

            // Auto-dismiss alerts after 5 seconds
            document.addEventListener("DOMContentLoaded", function () {
                const successAlert = document.getElementById("successAlert");
                const errorAlert = document.getElementById("errorAlert");

                if (successAlert) {
                    setTimeout(function () {
                        successAlert.style.transition = "opacity 0.5s";
                        successAlert.style.opacity = "0";
                        setTimeout(function () {
                            successAlert.remove();
                        }, 500);
                    }, 5000);
                }

                if (errorAlert) {
                    setTimeout(function () {
                        errorAlert.style.transition = "opacity 0.5s";
                        errorAlert.style.opacity = "0";
                        setTimeout(function () {
                            errorAlert.remove();
                        }, 500);
                    }, 5000);
                }
            });
        </script>
    </body>
</html>
